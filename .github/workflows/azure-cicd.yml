name: Auto-Healing Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  terraform_plan:
    name: Terraform Plan
    id: plan
    uses: ./.github/workflows/terraform-reusable.yml
    with:
      action: plan
      working-directory: terraform
    secrets:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    if: github.event.inputs.action == 'plan'

  terraform_apply:
    name: Terraform Apply
    id: apply
    uses: ./.github/workflows/terraform-reusable.yml
    with:
      action: apply
      working-directory: terraform
    secrets:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    if: github.event.inputs.action == 'apply'

  terraform_destroy:
    name: Terraform Destroy
    id: destroy
    uses: ./.github/workflows/terraform-reusable.yml
    with:
      action: destroy
      working-directory: terraform
    secrets:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    if: github.event.inputs.action == 'destroy'
